version: '3.8'

services:
  # ==========================================
  # Backend API Service
  # ==========================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      # Required variables (set in .env file or here)
      - GROQ_API_KEY=${GROQ_API_KEY}
      - GMAIL_USER=${GMAIL_USER}
      - GMAIL_APP_PASSWORD=${GMAIL_APP_PASSWORD}
      - ENVIRONMENT=production
      - DEBUG=False
      - API_HOST=0.0.0.0
      - API_PORT=8000
    volumes:
      # Persist logs and visualizations
      - ./logs:/app/logs
      - ./visualizations:/app/visualizations
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - audit-network
  # ==========================================
  # Nginx Reverse Proxy (Optional)
  # Uncomment to add HTTPS and serve frontend
  # ==========================================
  # nginx:
  #   image: nginx:alpine
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./frontend:/usr/share/nginx/html:ro
  #     - ./ssl:/etc/nginx/ssl:ro  # Add your SSL certificates
  #   depends_on:
  #     - api
  #   restart: unless-stopped
  #   networks:
  #     - audit-network

networks:
  audit-network:
    driver: bridge

# ==========================================
# Usage Instructions:
# ==========================================
# 1. Create .env file with your secrets:
#    GROQ_API_KEY=your_key
#    GMAIL_USER=your_email
#    GMAIL_APP_PASSWORD=your_password
#
# 2. Start services:
#    docker-compose up -d
#
# 3. View logs:
#    docker-compose logs -f api
#
# 4. Stop services:
#    docker-compose down
#
# 5. Rebuild after changes:
#    docker-compose up -d --build
# ==========================================
